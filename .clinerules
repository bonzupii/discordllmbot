# Copilot Development Rules for DiscordLLMBot

## 1. Critical Patterns & Code Style (DO NOT BREAK)

- **Nullish Coalescing:** Always use `??` for default values, not `||`.
- **Function Naming:** Use verb-first names (e.g., `buildPrompt`, `getRelationship`).
- **Message Filtering:** The initial checks in `messageCreate.js` must be `if (message.author.bot) return` and `if (!message.guild) return`.
- **Context Slicing:** When building prompts, always remove the triggering message from the context array with `.slice(0, -1)` to prevent the bot from echoing.
- **Persistence Layer:** All database interactions must go through `shared/storage/persistence.js`.
- **Error Fallback:** The default user-facing error message should be simple, like "I'm having some brain lag, give me a second."
- **Configuration:** All bot configuration is stored in PostgreSQL (`global_config` and `server_configs` tables). Use `shared/config/configLoader.js` to load/save config.

---

## 2. Guided Workflow & Session Management

This project uses a guided workflow. Instead of automating session management, you will be prompted for each step.

- **To Start a Session:** I will ask you to create a session file in `docs/sessions/`.
- **To Log Changes:** I will ask you to update the current session file with notes on changes, decisions, or discoveries.
- **To Commit:** I will ask you to commit changes using a specific format. You should generate the `git commit` command for me to review.

**Commit Message Format:**
```
<type>(<scope>): <subject>

See docs/sessions/YYYY-MM-DD.md for session notes
```
- **Types:** `feat`, `fix`, `docs`, `refactor`, `chore`
- **Scope:** The primary module affected (e.g., `memory`, `llm`, `bot`, `dashboard`, `config`).

---

## 3. Architecture & Feature Development

- **Architectural Changes:** Before making significant architectural changes, I will ask you to create an Architecture Decision Record (ADR) in `docs/adr/`.
- **Adding Features:** When asked to add a new feature, consider:
  1.  **Location:** Where does the new logic belong (`memory`, `llm`, `personality`, `core`, `api`, etc.)?
  2.  **Prompt Impact:** Does this change how the prompt is built in `bot/src/core/prompt.js`?
  3.  **User-Specificity:** Does this involve user-specific data? If so, use the `relationships.js` module.
  4.  **Logging:** Ensure all major operations are logged via the `logger` utility.
  5.  **Dashboard Integration:** Does this need UI exposure? Add API endpoints in `bot/src/api/server.js` and update dashboard components.

---

## 4. Log Analysis

- When asked to diagnose an issue, start by checking the `discordllmbot.log` file at the project root.
- This log is recreated on each bot startup and contains all console output, including errors, warnings, and API metrics.

---

## 5. Container Architecture

- **Single Bot Container:** The bot and API run in the same container (`bot` service). There is no separate `api` container.
- **Port 3000:** The Express + Socket.io API server runs on port 3000 within the bot container.
- **Shared State:** The API has direct access to the Discord client and all bot state (no internal HTTP calls needed).

